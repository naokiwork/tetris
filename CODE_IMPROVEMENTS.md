# コード改善点リスト

## 🔴 高優先度（即座に修正すべき）

### 1. エラーハンドリングの追加
**場所**: `src/main.ts:1`
- ゲームの初期化時にエラーハンドリングがない
- **修正**: try-catchブロックを追加して、エラー時に適切なメッセージを表示

### 2. Canvas要素の存在確認
**場所**: `src/renderer.ts:20`
- Canvas要素が存在しない場合のエラーハンドリングが不十分
- **修正**: より詳細なエラーメッセージとフォールバック処理を追加

## 🟡 中優先度（パフォーマンス・UX改善）

### 3. ゲームループの最適化
**場所**: `src/main.ts:45`
- requestAnimationFrameの使用は良いが、フレームレート制限がない
- **修正**: 60FPSに制限するか、可変フレームレートに対応

### 4. キーリピート処理の改善
**場所**: `src/input.ts:45`
- キーリピートのタイミングが固定値
- **修正**: ゲームの状態に応じて調整可能にする

### 5. 描画の最適化
**場所**: `src/renderer.ts:35`
- 毎フレーム全体を再描画している
- **修正**: 変更があった部分のみ再描画する差分描画を実装

## 🟢 低優先度（コード品質・保守性）

### 6. 定数の一元管理
**場所**: `src/renderer.ts:15`
- マジックナンバー（CELL_SIZE等）が散在している
- **修正**: 定数ファイルを作成して一元管理

### 7. 型定義の強化
**場所**: `src/types.ts:1`
- 一部の型定義が緩い
- **修正**: より厳密な型定義を追加（例: リテラル型の使用）

### 8. コメントの追加
**場所**: `src/game.ts:1`
- 複雑なロジックにコメントが不足している
- **修正**: JSDocコメントを追加して可読性を向上

### 9. テストコードの追加
**場所**: `プロジェクト全体`
- ユニットテストがない
- **修正**: Jest等を使用してテストコードを追加

### 10. アクセシビリティの改善
**場所**: `index.html:1`
- キーボード操作の説明はあるが、ARIA属性が不足
- **修正**: ARIA属性を追加してスクリーンリーダー対応を改善

## 📝 修正案（UX改善）

### 11. ゲームオーバー時のリスタート処理の改善
**場所**: `src/main.ts:26`
- リスタートボタンをクリックしても、モーダルが閉じるだけでゲームが再開されない場合がある
- **修正**: `game.start()`を呼び出した後に、ゲームループが確実に再開されるようにする。また、アニメーションフレームIDをリセット

### 12. 一時停止機能の視覚的フィードバック追加
**場所**: `src/main.ts:68`
- 一時停止時に画面に何も表示されず、ユーザーが一時停止状態かどうか分からない
- **修正**: 一時停止時にオーバーレイを表示し、「PAUSED」テキストと再開方法を表示する

### 13. スコア表示のアニメーション追加
**場所**: `src/renderer.ts:240`
- スコアが変更されても視覚的なフィードバックがない
- **修正**: スコアが増加した際に、数値がカウントアップするアニメーションを追加。CSS transitionを使用

### 14. レベルアップ時の通知表示
**場所**: `src/score.ts:30`
- レベルが上がってもユーザーに通知されない
- **修正**: レベルアップ時に画面上部に通知バナーを表示し、3秒後に自動で消えるアニメーションを追加

### 15. ピース固定時の視覚効果追加
**場所**: `src/game.ts:243`
- ピースが固定される際に視覚的なフィードバックがない
- **修正**: ピース固定時に、固定されたブロックが一瞬光るエフェクトを追加。Canvasで白いフラッシュを描画

## 🚀 改善点（機能追加）

### 16. レスポンシブデザインの改善（モバイル対応）
**場所**: `styles/main.css:1`
- 現在のデザインはデスクトップ向けで、モバイルでの操作性が悪い
- **修正**: タッチ操作に対応したボタンUIを追加。画面サイズに応じてCanvasのサイズを調整。スワイプジェスチャーでピースを移動

### 17. キーボードショートカットのカスタマイズ機能
**場所**: `src/input.ts:52`
- キー配置が固定されており、ユーザーが変更できない
- **修正**: 設定画面を追加し、各操作に割り当てるキーをカスタマイズ可能にする。設定はlocalStorageに保存

### 18. ゲーム設定の保存機能（ローカルストレージ）
**場所**: `src/game.ts:26`
- ゲーム設定（音量、キー配置等）が保存されない
- **修正**: localStorageを使用して設定を保存。ゲーム開始時に設定を読み込む機能を追加

### 19. サウンドエフェクトの追加
**場所**: `プロジェクト全体`
- 音声フィードバックがない
- **修正**: Web Audio APIを使用して、ピース移動、回転、ライン消去、ゲームオーバー時の効果音を追加。音量調整機能も実装

### 20. ハイスコア記録機能
**場所**: `src/score.ts:1`
- 最高スコアが記録されない
- **修正**: localStorageを使用してハイスコアを保存。ゲームオーバー時にハイスコアを更新し、UIに表示する機能を追加

## 💡 改善案（将来の機能）

### 21. マルチプレイヤーモード
**場所**: `新規実装`
- 現在はシングルプレイヤーのみ
- **修正**: WebSocketを使用したリアルタイムマルチプレイヤー機能を追加。2人対戦モードを実装

### 22. リプレイ機能
**場所**: `新規実装`
- ゲームのリプレイができない
- **修正**: 各操作を記録し、JSON形式で保存。リプレイ時に操作を再現する機能を追加

### 23. 統計情報の詳細表示
**場所**: `src/score.ts:1`
- 基本的なスコア情報のみで、詳細な統計がない
- **修正**: 総プレイ時間、平均スコア、最高レベル、総消去ライン数などの統計情報を表示する画面を追加

### 24. テーマカラーのカスタマイズ
**場所**: `src/types.ts:30`
- ピースの色が固定されている
- **修正**: ユーザーがピースの色をカスタマイズできる機能を追加。複数のテーマプリセットを用意

### 25. チュートリアルモード
**場所**: `新規実装`
- 初心者向けのガイドがない
- **修正**: 初回起動時にチュートリアルを表示。基本的な操作方法を段階的に説明するインタラクティブなガイドを実装

## 🐛 バグ修正

### 26. ゲームオーバー後にリスタートボタンが機能しない場合がある
**場所**: `src/main.ts:29`
- ゲームオーバー後にリスタートボタンをクリックしても、ゲームが再開されない場合がある
- **修正**: `game.start()`の呼び出し後に、ゲームループが確実に再開されるようにする。また、ゲーム状態をリセットする処理を追加

### 27. 高速でキーを連打すると入力が無視される
**場所**: `src/input.ts:30`
- キーを高速で連打すると、一部の入力が無視される
- **修正**: キーの状態管理を改善し、キーが押されている間は確実に処理されるようにする。キューシステムを実装

### 28. ピースが画面外に表示される可能性
**場所**: `src/pieces.ts:63`
- ピースの初期位置が適切でない場合、画面外に表示される
- **修正**: ピースの出現位置を検証し、画面内に収まるように調整する処理を追加。特にIピースの横長形状に注意

### 29. ゴーストピースが正しく表示されない場合がある
**場所**: `src/renderer.ts:85`
- ゴーストピースの位置計算が不正確で、実際の落下位置とずれる場合がある
- **修正**: `getGhostPosition`メソッドのロジックを確認し、正確な位置を計算するように修正。ボードの境界チェックを強化

### 30. ホールド機能でピースが正しく交換されない場合がある
**場所**: `src/game.ts:211`
- ホールド機能を使用した際に、ピースが正しく交換されない、または重複して表示される場合がある
- **修正**: ホールド処理のロジックを確認し、ピースの状態管理を改善。`canHold`フラグのリセットタイミングを修正

